<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Neowana 공유</title>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 24px }
    .hint { color:#666; font-size: 14px }
    #log { font-size: 13px; white-space: pre-wrap; color:#111; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-top:12px }
    #pick { margin-top: 12px; padding:10px 14px; border-radius:8px; background:#2563eb; color:#fff; border:0; }
    #magnetWrap { display:none; margin-top: 12px }
    a { word-break: break-all }
  </style>
</head>
<body>
  <h2>🎧 Neowana 공유</h2>
  <p class="hint">파일을 선택하면 브라우저에서 시딩을 시작하고, 마그넷 링크를 만들어 앱으로 보내줍니다.</p>

  <input id="fileInput" type="file" accept="audio/*" style="display:none" />
  <button id="pick">파일 선택</button>

  <div id="magnetWrap">
    <p>마그넷: <a id="magnetLink" href="#" target="_blank"></a></p>
  </div>

  <div id="log"></div>

  <script>
    const client = new WebTorrent();
    const input = document.getElementById('fileInput');
    const pick  = document.getElementById('pick');
    const linkA = document.getElementById('magnetLink');
    const wrap  = document.getElementById('magnetWrap');
    const logEl = document.getElementById('log');

    function log(...args){ logEl.textContent += args.join(' ') + '\n'; }

    // RN WebView 쪽에서 "파일 선택" 요청 받을 수도 있음 (옵션)
    window.addEventListener('message', e => {
      try {
        const data = JSON.parse(e.data || '{}');
        if (data.type === 'OPEN_FILE_PICKER') input.click();
      } catch {}
    });

    pick.addEventListener('click', () => input.click());

    input.addEventListener('change', () => {
      const file = input.files && input.files[0];
      if (!file) return;

      log('시딩 시작:', file.name);
      const trackers = [
        'wss://tracker.openwebtorrent.com',
        'wss://tracker.btorrent.xyz',
        'wss://tracker.webtorrent.dev',
        'wss://tracker.files.fm:7073/announce'
      ];

      client.seed(file, { announce: trackers }, torrent => {
        const href = 'magnet:?xt=urn:btih:' + torrent.infoHash
          + '&dn=' + encodeURIComponent(file.name)
          + trackers.map(t => '&tr=' + encodeURIComponent(t)).join('');

        log('마그넷 생성:', href);
        wrap.style.display = 'block';
        linkA.href = href;
        linkA.textContent = href;

        // ★ RN(WebView)로 마그넷 전송
        if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'MAGNET', href, name: file.name }));
          log('앱으로 마그넷 전달 완료 (postMessage).');
        } else {
          log('RN WebView 감지 안됨: 브라우저에서 테스트 중일 가능성.');
        }
      });
    });
  </script>
</body>
</html>
