<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Neowana ê³µìœ </title>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    .hint{color:#666;font-size:14px}
    #log{font-size:13px;white-space:pre-wrap;color:#111;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-top:12px}
    #magnetWrap{display:none;margin-top:8px}
    input[type=file]{margin-top:8px}
    button{margin-left:8px}
  </style>
</head>
<body>
  <h2>ğŸ§ Neowana ê³µìœ </h2>
  <p class="hint">íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë¸Œë¼ìš°ì €ê°€ WebRTCë¡œ ì‹œë”©ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì´ íƒ­ì„ ë‹«ìœ¼ë©´ ê³µìœ ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.</p>

  <input type="file" id="fileInput" />
  <p id="status">ëŒ€ê¸° ì¤‘â€¦</p>

  <div id="magnetWrap">
    <p>ê³µìœ  URL(ë§ˆê·¸ë„·): <a id="magnetLink" href="#" target="_blank"></a>
      <button id="copyBtn">ë³µì‚¬</button>
    </p>
  </div>

  <div id="log"></div>

  <script>
    const client = new WebTorrent();
    const fileInput = document.getElementById('fileInput');
    const statusEl  = document.getElementById('status');
    const magnetWrap= document.getElementById('magnetWrap');
    const magnetLink= document.getElementById('magnetLink');
    const copyBtn   = document.getElementById('copyBtn');
    const logEl     = document.getElementById('log');

    function log(...a){ statusEl.textContent = a.join(' '); logEl.textContent += a.join(' ') + '\n'; }

    // RN(WebView)ì—ì„œ "íŒŒì¼ ì„ íƒ ì—´ì–´ì¤˜" ë©”ì‹œì§€ ë°›ìœ¼ë©´ input í´ë¦­
    window.addEventListener('message', (e)=>{
      try{
        const data = JSON.parse(e.data);
        if (data?.type === 'OPEN_FILE_PICKER') {
          fileInput.click();
        }
      }catch {}
    });

    const trackers = [
      'wss://tracker.openwebtorrent.com',
      'wss://tracker.btorrent.xyz',
      'wss://tracker.webtorrent.dev',
      'wss://tracker.fastcast.nz',
      'wss://tracker.files.fm:7073/announce'
    ];

    client.on('error', err => log('CLIENT ERROR:', err.message));

    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      log('ì‹œë”© ì¤€ë¹„â€¦', file.name);
      client.seed(file, { announce: trackers }, torrent => {
        log('ì‹œë”© ì‹œì‘. infoHash =', torrent.infoHash, 'í”¼ì–´ ëŒ€ê¸°ì¤‘â€¦');

        // íŠ¸ë˜ì»¤ ë¶™ì¸ ë§ˆê·¸ë„· ì§ì ‘ ìƒì„± (í™˜ê²½ì— ë”°ë¼ magnetURIê°€ wss íŠ¸ë˜ì»¤ë¥¼ ì•ˆ ë‹¬ê³  ë‚˜ì˜¤ëŠ” ê²½ìš° ìˆìŒ)
        const href = 'magnet:?xt=urn:btih:' + torrent.infoHash +
          '&dn=' + encodeURIComponent(file.name) +
          trackers.map(t => '&tr=' + encodeURIComponent(t)).join('');

        magnetLink.textContent = href;
        magnetLink.href = href;
        magnetWrap.style.display = 'block';

        // RN(WebView)ë¡œë„ ì „ë‹¬
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type:'MAGNET', href }));
        }
      });
    });

    copyBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(magnetLink.textContent || '');
        log('ë§ˆê·¸ë„· ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
      }catch{
        log('ë³µì‚¬ ì‹¤íŒ¨. ë§í¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•˜ì„¸ìš”.');
      }
    });
  </script>
</body>
</html>
