<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Neowana ì¬ìƒ</title>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    .hint{color:#666;font-size:14px}
    #log{font-size:13px;white-space:pre-wrap;color:#111;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-top:12px}
    audio{width:100%;margin-top:12px}
  </style>
</head>
<body>
  <h2>ğŸ§ Neowana ì¬ìƒ</h2>
  <p class="hint">ì´ í˜ì´ì§€ëŠ” ë§ˆê·¸ë„· ë§í¬ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒì„ ì‹œë„í•©ë‹ˆë‹¤.</p>
  <p id="status">ì´ˆê¸°í™” ì¤‘â€¦</p>
  <div id="player"></div>
  <div id="log"></div>

  <script>
    const qs = new URLSearchParams(location.search);
    const magnet = qs.get('magnet');
    const statusEl = document.getElementById('status');
    const player = document.getElementById('player');
    const logEl = document.getElementById('log');

    function log(...args){ statusEl.textContent = args.join(' '); logEl.textContent += args.join(' ') + '\n'; }

    if (!magnet) {
      log('ë§ˆê·¸ë„· íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    } else {
      const client = new WebTorrent();
      const trackers = [
        // WebRTC (wss) íŠ¸ë˜ì»¤ë“¤
        'wss://tracker.openwebtorrent.com',
        'wss://tracker.btorrent.xyz',
        'wss://tracker.webtorrent.dev',
        'wss://tracker.files.fm:7073/announce',
        'wss://spacetradersapi-chatbox.uno:443/announce',
      ];

      const href = magnet + trackers.map(t => '&tr=' + encodeURIComponent(t)).join('');
      log('í† ë ŒíŠ¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘â€¦ (íŠ¸ë˜ì»¤ ì—°ê²° ì‹œë„)');

      client.on('error', e => log('CLIENT ERROR:', e.message));

      client.add(href, torrent => {
        log('í† ë ŒíŠ¸ ì¶”ê°€ ì™„ë£Œ. infoHash =', torrent.infoHash);

        // ë””ë²„ê¹…: í”¼ì–´ ìˆ˜ / ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
        const iv = setInterval(() => {
          log(`í”¼ì–´: ${torrent.numPeers} / ë‚´ë ¤ë°›ì€: ${(torrent.downloaded/1024/1024).toFixed(2)}MB / ì†ë„: ${(torrent.downloadSpeed/1024).toFixed(0)}KB/s`);
        }, 1000);

        torrent.on('wire', () => log('í”¼ì–´ ì—°ê²°ë¨. í˜„ì¬ í”¼ì–´:', torrent.numPeers));
        torrent.on('noPeers', a => log('í”¼ì–´ ì—†ìŒ ìœ í˜•:', a || 'unknown'));
        torrent.on('error', e => log('TORRENT ERROR:', e.message));

        // ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ
        const file = torrent.files.find(f => /\.(mp3|wav|m4a|aac|ogg)$/i.test(f.name)) || torrent.files[0];
        if (!file) {
          clearInterval(iv);
          log('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        log('ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘:', file.name);
        file.appendTo(player, { autoplay: true, controls: true }, err => {
          if (err) log('í”Œë ˆì´ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨:', err.message);
        });
      });
    }
  </script>
</body>
</html>
